package com.autoguard.malware_scanner

import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel

class MainActivity : FlutterActivity() {
    private lateinit var telemetryChannel: TelemetryChannel
    private lateinit var appEnumerator: AppEnumerator
    private lateinit var networkMonitor: NetworkMonitor
    private lateinit var processMonitor: ProcessMonitor
    
    companion object {
        const val APP_CHANNEL = "com.autoguard.malware_scanner/apps"
        const val SECURITY_CHANNEL = "com.autoguard.malware_scanner/security"
    }
    
    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        // Setup telemetry channel for real device/app scanning
        val telemetryMethodChannel = MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            TelemetryChannel.CHANNEL_NAME
        )
        
        telemetryChannel = TelemetryChannel(applicationContext)
        telemetryChannel.setupMethodChannel(telemetryMethodChannel)
        
        // Initialize behavioral monitors
        networkMonitor = NetworkMonitor(applicationContext)
        processMonitor = ProcessMonitor(applicationContext)
        processMonitor.startMonitoring()
        
        // Setup security channel for behavioral monitoring
        val securityChannel = MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            SECURITY_CHANNEL
        )
        
        securityChannel.setMethodCallHandler { call, result ->
            when (call.method) {
                "getNetworkThreats" -> {
                    val packageName = call.argument<String>("packageName")
                    if (packageName != null) {
                        val threats = networkMonitor.scanAppNetwork(packageName)
                        result.success(threats.map { mapOf(
                            "packageName" to it.packageName,
                            "type" to it.type.name,
                            "destination" to it.destination,
                            "description" to it.description,
                            "severity" to it.severity,
                            "timestamp" to it.timestamp
                        )})
                    } else {
                        result.success(emptyList<Map<String, Any>>())
                    }
                }
                "getProcessAnomalies" -> {
                    val packageName = call.argument<String>("packageName")
                    if (packageName != null) {
                        val anomalies = processMonitor.scanAppProcess(packageName)
                        result.success(anomalies.map { mapOf(
                            "packageName" to it.packageName,
                            "pid" to it.pid,
                            "type" to it.type.name,
                            "description" to it.description,
                            "severity" to it.severity,
                            "timestamp" to it.timestamp
                        )})
                    } else {
                        result.success(emptyList<Map<String, Any>>())
                    }
                }
                else -> result.notImplemented()
            }
        }
        
        // Setup app enumeration channel
        val appChannel = MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            APP_CHANNEL
        )
        
        appEnumerator = AppEnumerator(applicationContext)
        
        appChannel.setMethodCallHandler { call, result ->
            when (call.method) {
                "getInstalledApps" -> {
                    try {
                        val apps = appEnumerator.getInstalledApps()
                        result.success(apps)
                    } catch (e: Exception) {
                        result.error("APP_ENUM_ERROR", e.message, null)
                    }
                }
                "getAppDetails" -> {
                    val packageName = call.argument<String>("packageName")
                    if (packageName != null) {
                        try {
                            val details = appEnumerator.getAppDetails(packageName)
                            result.success(details)
                        } catch (e: Exception) {
                            result.error("APP_DETAILS_ERROR", e.message, null)
                        }
                    } else {
                        result.error("INVALID_ARGS", "packageName required", null)
                    }
                }
                "getInstalledAppCount" -> {
                    try {
                        val count = appEnumerator.getInstalledAppCount()
                        result.success(count)
                    } catch (e: Exception) {
                        result.error("COUNT_ERROR", e.message, null)
                    }
                }
                else -> result.notImplemented()
            }
        }
    }
}
