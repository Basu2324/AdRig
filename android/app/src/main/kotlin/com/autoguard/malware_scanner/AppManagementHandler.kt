package com.autoguard.malware_scanner

import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.provider.Settings
import io.flutter.plugin.common.MethodChannel

/**
 * Native Android handler for app management operations
 * Provides real quarantine/delete functionality using PackageManager APIs
 */
class AppManagementHandler(private val context: Context) {
    
    companion object {
        const val CHANNEL = "com.autoguard.malware_scanner/app_management"
    }
    
    fun handleMethodCall(call: io.flutter.plugin.common.MethodCall, result: MethodChannel.Result) {
        when (call.method) {
            "uninstallApp" -> {
                val packageName = call.argument<String>("packageName")
                if (packageName != null) {
                    uninstallApp(packageName, result)
                } else {
                    result.error("INVALID_ARGUMENT", "Package name is required", null)
                }
            }
            "disableApp" -> {
                val packageName = call.argument<String>("packageName")
                if (packageName != null) {
                    disableApp(packageName, result)
                } else {
                    result.error("INVALID_ARGUMENT", "Package name is required", null)
                }
            }
            "enableApp" -> {
                val packageName = call.argument<String>("packageName")
                if (packageName != null) {
                    enableApp(packageName, result)
                } else {
                    result.error("INVALID_ARGUMENT", "Package name is required", null)
                }
            }
            "isAppEnabled" -> {
                val packageName = call.argument<String>("packageName")
                if (packageName != null) {
                    isAppEnabled(packageName, result)
                } else {
                    result.error("INVALID_ARGUMENT", "Package name is required", null)
                }
            }
            "openAppSettings" -> {
                val packageName = call.argument<String>("packageName")
                if (packageName != null) {
                    openAppSettings(packageName, result)
                } else {
                    result.error("INVALID_ARGUMENT", "Package name is required", null)
                }
            }
            else -> {
                result.notImplemented()
            }
        }
    }
    
    /**
     * Uninstall an app - Opens system uninstall dialog
     * Note: Cannot programmatically uninstall without root or device owner permissions
     */
    private fun uninstallApp(packageName: String, result: MethodChannel.Result) {
        try {
            val intent = Intent(Intent.ACTION_DELETE).apply {
                data = Uri.parse("package:$packageName")
                flags = Intent.FLAG_ACTIVITY_NEW_TASK
            }
            context.startActivity(intent)
            result.success(mapOf(
                "success" to true,
                "message" to "Uninstall dialog opened for $packageName"
            ))
        } catch (e: Exception) {
            result.error("UNINSTALL_ERROR", "Failed to open uninstall dialog: ${e.message}", null)
        }
    }
    
    /**
     * Disable an app (requires root or device owner permissions on most devices)
     * This will show app settings page where user can manually disable
     */
    private fun disableApp(packageName: String, result: MethodChannel.Result) {
        try {
            val packageManager = context.packageManager
            
            // Try to disable (may fail due to permissions)
            try {
                packageManager.setApplicationEnabledSetting(
                    packageName,
                    PackageManager.COMPONENT_ENABLED_STATE_DISABLED_USER,
                    0
                )
                result.success(mapOf(
                    "success" to true,
                    "message" to "App disabled: $packageName"
                ))
            } catch (securityException: SecurityException) {
                // No permission to disable programmatically - open settings instead
                openAppSettings(packageName, result)
            }
        } catch (e: Exception) {
            result.error("DISABLE_ERROR", "Failed to disable app: ${e.message}", null)
        }
    }
    
    /**
     * Enable a previously disabled app
     */
    private fun enableApp(packageName: String, result: MethodChannel.Result) {
        try {
            val packageManager = context.packageManager
            
            packageManager.setApplicationEnabledSetting(
                packageName,
                PackageManager.COMPONENT_ENABLED_STATE_DEFAULT,
                0
            )
            result.success(mapOf(
                "success" to true,
                "message" to "App enabled: $packageName"
            ))
        } catch (e: Exception) {
            result.error("ENABLE_ERROR", "Failed to enable app: ${e.message}", null)
        }
    }
    
    /**
     * Check if an app is enabled
     */
    private fun isAppEnabled(packageName: String, result: MethodChannel.Result) {
        try {
            val packageManager = context.packageManager
            val applicationInfo = packageManager.getApplicationInfo(packageName, 0)
            val isEnabled = applicationInfo.enabled
            
            result.success(mapOf(
                "enabled" to isEnabled,
                "packageName" to packageName
            ))
        } catch (e: PackageManager.NameNotFoundException) {
            result.error("APP_NOT_FOUND", "App not found: $packageName", null)
        } catch (e: Exception) {
            result.error("CHECK_ERROR", "Failed to check app status: ${e.message}", null)
        }
    }
    
    /**
     * Open app settings page where user can manually disable/uninstall
     */
    private fun openAppSettings(packageName: String, result: MethodChannel.Result) {
        try {
            val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
                data = Uri.parse("package:$packageName")
                flags = Intent.FLAG_ACTIVITY_NEW_TASK
            }
            context.startActivity(intent)
            result.success(mapOf(
                "success" to true,
                "message" to "App settings opened for $packageName"
            ))
        } catch (e: Exception) {
            result.error("SETTINGS_ERROR", "Failed to open app settings: ${e.message}", null)
        }
    }
}
