package com.autoguard.malware_scanner

import android.content.Context
import android.content.pm.ApplicationInfo
import android.content.pm.PackageInfo
import android.content.pm.PackageManager
import android.os.Build
import io.flutter.plugin.common.MethodChannel
import java.io.File

/**
 * Real Android app enumeration using PackageManager
 * NO HARDCODED DATA - scans actual installed packages
 */
class AppEnumerator(private val context: Context) {

    /**
     * Get all installed applications from device
     * @return List of maps containing app metadata
     */
    fun getInstalledApps(): List<Map<String, Any?>> {
        val pm = context.packageManager
        val apps = mutableListOf<Map<String, Any?>>()

        // Get ALL installed packages including system apps
        val installedPackages = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            pm.getInstalledPackages(
                PackageManager.PackageInfoFlags.of(
                    (PackageManager.GET_PERMISSIONS or PackageManager.GET_META_DATA).toLong()
                )
            )
        } else {
            @Suppress("DEPRECATION")
            pm.getInstalledPackages(
                PackageManager.GET_PERMISSIONS or PackageManager.GET_META_DATA
            )
        }

        for (packageInfo in installedPackages) {
            try {
                val appInfo = packageInfo.applicationInfo ?: continue
                val appData = buildAppMetadata(pm, packageInfo, appInfo)
                apps.add(appData)
            } catch (e: Exception) {
                println("Error processing package ${packageInfo.packageName}: ${e.message}")
                continue
            }
        }

        println("AppEnumerator: Found ${apps.size} real installed apps")
        return apps
    }

    /**
     * Get detailed metadata for a specific app
     */
    fun getAppDetails(packageName: String): Map<String, Any?>? {
        return try {
            val pm = context.packageManager

            val packageInfo = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                pm.getPackageInfo(
                    packageName,
                    PackageManager.PackageInfoFlags.of(
                        (PackageManager.GET_PERMISSIONS or 
                         PackageManager.GET_META_DATA or
                         PackageManager.GET_SIGNATURES).toLong()
                    )
                )
            } else {
                @Suppress("DEPRECATION")
                pm.getPackageInfo(
                    packageName,
                    PackageManager.GET_PERMISSIONS or 
                    PackageManager.GET_META_DATA or 
                    PackageManager.GET_SIGNATURES
                )
            }

            val appInfo = packageInfo.applicationInfo ?: return null
            buildAppMetadata(pm, packageInfo, appInfo)
        } catch (e: Exception) {
            println("Error getting app details for $packageName: ${e.message}")
            null
        }
    }

    private fun buildAppMetadata(
        pm: PackageManager,
        packageInfo: PackageInfo,
        appInfo: ApplicationInfo
    ): Map<String, Any?> {
        val appName = pm.getApplicationLabel(appInfo).toString()
        val packageName = packageInfo.packageName
        val version = packageInfo.versionName ?: "unknown"
        val versionCode = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
            packageInfo.longVersionCode
        } else {
            @Suppress("DEPRECATION")
            packageInfo.versionCode.toLong()
        }

        // Get APK file path and size
        val apkPath = appInfo.sourceDir
        val apkFile = File(apkPath)
        val apkSize = if (apkFile.exists()) apkFile.length() else 0L

        // Check if system app
        val isSystemApp = (appInfo.flags and ApplicationInfo.FLAG_SYSTEM) != 0

        // Get installer package
        val installerPackage = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
            pm.getInstallSourceInfo(packageName).installingPackageName
        } else {
            @Suppress("DEPRECATION")
            pm.getInstallerPackageName(packageName)
        } ?: "unknown"

        // Get install/update times
        val installTime = packageInfo.firstInstallTime
        val lastUpdateTime = packageInfo.lastUpdateTime

        // Get permissions
        val requestedPermissions = packageInfo.requestedPermissions?.toList() ?: emptyList()
        val grantedPermissions = mutableListOf<String>()
        
        packageInfo.requestedPermissions?.forEachIndexed { index, permission ->
            val flags = packageInfo.requestedPermissionsFlags
            if (flags != null && index < flags.size) {
                if ((flags[index] and PackageInfo.REQUESTED_PERMISSION_GRANTED) != 0) {
                    grantedPermissions.add(permission)
                }
            }
        }

        // Get native libraries
        val nativeLibraryDir = appInfo.nativeLibraryDir
        val hasNativeCode = nativeLibraryDir != null && File(nativeLibraryDir).exists()

        // Data directory
        val dataDir = appInfo.dataDir

        return mapOf(
            "packageName" to packageName,
            "appName" to appName,
            "version" to version,
            "versionCode" to versionCode,
            "apkPath" to apkPath,
            "size" to apkSize,
            "isSystemApp" to isSystemApp,
            "installerPackage" to installerPackage,
            "installTime" to installTime,
            "lastUpdateTime" to lastUpdateTime,
            "requestedPermissions" to requestedPermissions,
            "grantedPermissions" to grantedPermissions,
            "hasNativeCode" to hasNativeCode,
            "nativeLibraryDir" to nativeLibraryDir,
            "dataDir" to dataDir,
            "targetSdkVersion" to appInfo.targetSdkVersion,
            "minSdkVersion" to if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
                appInfo.minSdkVersion
            } else {
                0
            },
            "enabled" to appInfo.enabled,
            "uid" to appInfo.uid
        )
    }

    /**
     * Get count of installed apps
     */
    fun getInstalledAppCount(): Int {
        return try {
            val pm = context.packageManager
            
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                val flags = PackageManager.PackageInfoFlags.of(0)
                pm.getInstalledPackages(flags).size
            } else {
                @Suppress("DEPRECATION")
                pm.getInstalledPackages(0).size
            }
        } catch (e: Exception) {
            0
        }
    }
}
